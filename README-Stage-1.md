##  *Momo Store aka ÐŸÐµÐ»ÑŒÐ¼ÐµÐ½Ð½Ð°Ñ â„–2 &trade;*
*Ð¡Ð´ÐµÐ»Ð°Ð½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼ *std-030-35@praktikum-services.ru* Ð¾Ð½ Ð¶Ðµ **ÐÐ»ÐµÐºÑÐµÐ¹ Ð”Ñ‘Ð¼Ð¸Ð½***

---
![My Momo Store](/images/storemomo.png "My Momo Store")  
___


## *ÐŸÐµÑ€Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ð¿ - ÐŸÐ¾Ð³Ð½Ð°Ð»Ð¸ :)*

**Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ**:
>
> * ÐšÐ¾Ð´ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð² GitLab Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð»ÑŽÐ±Ð¾Ð³Ð¾ git-flow  
> * Ð’ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ .gitlab-ci.yml, Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ñ‹ ÑˆÐ°Ð³Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸
> * ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ (Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹, docker-Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¸Ð»Ð¸ Ð´Ñ€.) Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÑŽÑ‚ÑÑ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ (Nexus Ð¸Ð»Ð¸ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸)
> * ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ
> * ÐÐ°Ð¿Ð¸ÑÐ°Ð½Ñ‹ Dockerfile'Ñ‹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ Docker-Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð±ÑÐºÐµÐ½Ð´Ð° Ð¸ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
> * Ð‘ÑÐºÐµÐ½Ð´: Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Go Ð² Docker-Ð¾Ð±Ñ€Ð°Ð·Ðµ
> * Ð¤Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´: HTML-ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ñ€Ð°Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ Ñ Nginx
> * Ð’ GitLab CI Ð¾Ð¿Ð¸ÑÐ°Ð½ ÑˆÐ°Ð³ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
> * Ð’ GitLab CI Ð¾Ð¿Ð¸ÑÐ°Ð½ ÑˆÐ°Ð³ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
> * Ð’ GitLab CI Ð¾Ð¿Ð¸ÑÐ°Ð½ ÑˆÐ°Ð³ Ð´ÐµÐ¿Ð»Ð¾Ñ

___
  


**Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ð°:**

- Ð‘Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ - https://gitlab.praktikum-services.ru/std-030-35/momo-store  

![My Momo Store](/images/repos.png "My Momo Store")  

- Ð‘Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð³Ð»Ð°Ð²Ð½Ñ‹Ð¹ **gitlab-ci.yml**, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² ÐºÐ¾Ñ€Ð½Ðµ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ.

```yaml
stages:
  - module-pipelines

frontend:
  stage: module-pipelines
  trigger:
    include:
      - "/frontend/.gitlab-ci.yml"
    strategy: depend
  only:
    changes:
      - frontend/**/*

backend:
  stage: module-pipelines
  trigger:
    include:
      - "/backend/.gitlab-ci.yml"
    strategy: depend
  only:
    changes:
      - backend/**/*

```  
  
- ÐÑ€Ñ‚Ð¸Ñ„Ð°ÐºÑ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¼Ñ‹ Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÐµÐ¼ Ð² **Container Registry** - https://gitlab.praktikum-services.ru/std-030-35/momo-store/container_registry 

- Ð¡Ð¾Ð·Ð´Ð°Ð½Ñ‹ Dockerfile Ð´Ð»Ñ Ð¾Ð±Ð¾Ð¸Ñ… ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð² ÐŸÐµÐ»ÑŒÐ¼ÐµÐ½Ð½Ð¾Ð¹.

##  *Backend* ðŸ³
Ð¡Ð¸Ð»ÑŒÐ½Ð¾ Ð¿Ð¾Ð¼Ð¾Ð³Ð»Ð° Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ - https://docs.docker.com/guides/golang/build-images/  

```yaml
# Stage 1: Ð¡Ð±Ð¾Ñ€ÐºÐ° backend - Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð».
FROM golang:1.20 AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN go build -o api ./cmd/api

# Stage 2: Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð».
FROM gcr.io/distroless/base
WORKDIR /app
COPY --from=builder /app/api .

EXPOSE 8081

CMD ["./api"]
```  
##  *Frontend* ðŸ³


```yaml
# Stage 1: Build the frontend
FROM node:16.20.0-alpine3.18 AS builder
WORKDIR /usr/src/app
COPY . .
# VUE_APP_BASE_URL=http://std-030-78.praktikum-services.tech/  - Ð·Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð½Ð° ÑÐ²Ð¾ÑŽ dns Ð·Ð°Ð¿Ð¸ÑÑŒ
ENV VUE_APP_BASE_URL=http://std-030-78.praktikum-services.tech/
ENV NODE_ENV=test
ENV VUE_APP_API_URL=http://std-030-78.praktikum-services.tech:8081
RUN npm install
# NODE_ENV=production - Ð¼ÐµÐ½ÑÐµÐ¼ Ñ‡Ñ‚Ð¾Ð± Ð½Ðµ Ð±Ñ‹Ð»Ð¾ Ð² Ð¿ÑƒÑ‚Ð¸ http://std-030-78.praktikum-services.tech:8081/momo-store/
RUN npm run build

# Stage 2: Serve the frontend with Nginx
FROM nginx:stable-alpine3.17-slim
WORKDIR /app
COPY --from=builder /usr/src/app/dist /usr/share/nginx/html
EXPOSE 80
```
---
- Ð’ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ðµ ÑÐ±Ð¾Ñ€ÐºÐ¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð¼Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‰ÑƒÑŽ Ð¿ÐµÐ»ÑŒÐ¼ÐµÐ½Ð½ÑƒÑŽ, Ð¸ Ð´Ð°Ð»ÑŒÑˆÐµ Ð´Ð²Ð¸Ð³Ð°ÐµÐ¼ÑÑ Ð² ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñƒ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ð¸.  
ÐŸÐ¸ÑˆÐµÐ¼ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÐµÑ€Ð²Ð¸ÑÐ°, Backend/Frontend ÑÐ²Ð¾Ð¸ **momo-store/frontend/.gitlab-ci.yml** Ð¸ **momo-store/backend/.gitlab-ci.yml**

> Frontend - https://gitlab.praktikum-services.ru/std-030-35/momo-store/-/blob/main/frontend/.gitlab-ci.yml?ref_type=heads  
> Backend - https://gitlab.praktikum-services.ru/std-030-35/momo-store/-/blob/main/backend/.gitlab-ci.yml?ref_type=heads

- Ð”Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ Docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ **Docker-in-Docker** Ð° Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ð· **gcr.io/kaniko-project/executor**
  
Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ñ 
```YAML
variables:
  VERSION: 1.0.${CI_PIPELINE_ID}  # ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð´Ð»Ñ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ Ð½Ð°ÑˆÐ¸Ñ… ÑÐ±Ð¾Ñ€Ð¾Ðº

stages:
  - build    # Ð¡Ð¾Ñ€ÐºÐ° docker Ð¾Ð±Ñ€Ð°Ð·Ð°
  - release  # Ð’Ñ‹Ð³Ñ€ÑƒÐ·ÐºÐ° Ð³Ð¾Ñ‚Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ð±Ñ€Ð°Ð·Ð° Ð² Container Registry
  - deploy   # Ð”ÐµÐ¿Ð»Ð¾Ð¹ docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð½Ð° Ñ…Ð¾ÑÑ‚

build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:v1.9.0-debug
    entrypoint: [""]
  script:
    - /kaniko/executor
      --context "${CI_PROJECT_DIR}/backend"
      --dockerfile "${CI_PROJECT_DIR}/backend/Dockerfile"   # ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð½Ð°Ñˆ Dockerfile 
      --destination "${CI_REGISTRY_IMAGE}/momo-backend:$CI_COMMIT_SHA"
      --build-arg VERSION=$VERSION
      --cache=true

release:
  variables:
    GIT_STRATEGY: none
  image:
    name: gcr.io/go-containerregistry/crane:debug
    entrypoint: [""]
  cache: []
  stage: release
  before_script:
    - crane auth login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - crane tag $CI_REGISTRY_IMAGE/momo-backend:$CI_COMMIT_SHA $VERSION  

# Ð¡Ñ‚Ð°Ð´Ð¸Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ñ… docker ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² Ð½Ð° Ð½Ð°Ñˆ Ñ…Ð¾ÑÑ‚
deploy:
  stage: deploy
  image: alpine:3.18
  before_script:
    - apk add openssh-client bash gettext
    - eval $(ssh-agent -s)
    - echo "${SSH_PRIVATE_KEY}" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    - ssh-keygen -R ${DEV_HOST}
    - ssh -o StrictHostKeyChecking=no ${DEV_USER}@${DEV_HOST} "mkdir -p /tmp/${CI_PROJECT_DIR}/backend/"
    - envsubst < ./backend/deploy.sh|ssh ${DEV_USER}@${DEV_HOST}
  script:
    - echo "Deployment step is complete"

```

- ÐŸÑ€Ð¸ ÑÑ‚Ð¾Ð¼ Ð¼Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐºÑ€Ð¸Ð¿Ñ‚ deploy.sh ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð´Ð»Ñ backend Ð²Ñ‹Ð³Ð»ÑÐ´Ð¸Ñ‚ Ñ‚Ð°Ðº:  
```bash
#! /bin/bash
set -xe
sudo docker login -u ${CI_REGISTRY_USER} -p${CI_REGISTRY_PASSWORD} ${CI_REGISTRY}
sudo docker network create -d bridge momo_network || true  # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½ÑƒÑŽ ÑÐµÑ‚ÑŒ Ð´Ð»Ñ Ð½Ð°ÑˆÐµÐ¹ ÐŸÐµÐ»ÑŒÐ¼ÐµÐ½Ð½Ð¾Ð¹
sudo docker rm -f momo-backend || true
sudo docker run -d --name momo-backend \
     -p 8081:8081 \
     --network=momo_network \
     --restart=always \
     "${CI_REGISTRY_IMAGE}"/momo-backend:$VERSION
```
---
- **Ð’ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ðµ Ð½Ð°Ð¼ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð¿Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð½Ð° Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑÑ‚Ð°Ð¿ Ð·Ð°Ð´Ð°Ñ‡Ð¸.** ðŸ‘ŒðŸ’ª ðŸ˜Ž

âœ…  ÐšÐ¾Ð´ Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑÑ Ð² GitLab Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼ Ð»ÑŽÐ±Ð¾Ð³Ð¾ git-flow  
âœ… Ð’ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚ .gitlab-ci.yml, Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ð¼ Ð¾Ð¿Ð¸ÑÐ°Ð½Ñ‹ ÑˆÐ°Ð³Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ¸  
âœ… ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ (Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹, docker-Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð¸Ð»Ð¸ Ð´Ñ€.) Ð¿ÑƒÐ±Ð»Ð¸ÐºÑƒÑŽÑ‚ÑÑ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ (Nexus Ð¸Ð»Ð¸ Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸)  
âœ…  ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð²ÐµÑ€ÑÐ¸Ð¾Ð½Ð¸Ñ€ÑƒÑŽÑ‚ÑÑ  
âœ…   ÐÐ°Ð¿Ð¸ÑÐ°Ð½Ñ‹ Dockerfile'Ñ‹ Ð´Ð»Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ Docker-Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð² Ð±ÑÐºÐµÐ½Ð´Ð° Ð¸ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°  
âœ…   Ð‘ÑÐºÐµÐ½Ð´: Ð±Ð¸Ð½Ð°Ñ€Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Go Ð² Docker-Ð¾Ð±Ñ€Ð°Ð·Ðµ  
âœ…  Ð¤Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´: HTML-ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ñ€Ð°Ð·Ð´Ð°Ñ‘Ñ‚ÑÑ Ñ Nginx  
âœ… Ð’ GitLab CI Ð¾Ð¿Ð¸ÑÐ°Ð½ ÑˆÐ°Ð³ ÑÐ±Ð¾Ñ€ÐºÐ¸ Ð¸ Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ°Ñ†Ð¸Ð¸ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²  
âœ… Ð’ GitLab CI Ð¾Ð¿Ð¸ÑÐ°Ð½ ÑˆÐ°Ð³ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ  
âœ… Ð’ GitLab CI Ð¾Ð¿Ð¸ÑÐ°Ð½ ÑˆÐ°Ð³ Ð´ÐµÐ¿Ð»Ð¾Ñ
  
---
 


 
